@{
    ViewBag.Title = "Change Password";
    var user = ViewBag.User as AWEElectronics.DTO.User;
}

<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-key"></i> Change Password</h2>
        <p class="text-muted">Update password for user: <strong>@user.Username</strong></p>
    </div>
</div>

@if (ViewBag.ErrorMessage != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-exclamation-circle"></i> @ViewBag.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row">
    <div class="col-md-6 col-lg-5">
        <div class="card shadow">
            <div class="card-body">
                <form method="post" action="@Url.Action("ChangePassword", "Users", new { id = user.UserID })">
                    @Html.AntiForgeryToken()

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> You are changing the password for: <strong>@user.FullName</strong> (@user.Username)
                    </div>

                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            <input type="password" class="form-control" id="currentPassword" name="currentPassword"
                                   required placeholder="Enter current password">
                        </div>
                        <div class="form-text">Enter the user's current password to confirm</div>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-key"></i></span>
                            <input type="password" class="form-control" id="newPassword" name="newPassword"
                                   required minlength="6" placeholder="Enter new password (min. 6 characters)">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-check"></i></span>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                                   required minlength="6" placeholder="Re-enter new password">
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Security Notice:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Password must be at least 6 characters long</li>
                            <li>Choose a strong, unique password</li>
                            <li>The user will need to use the new password on next login</li>
                        </ul>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                        <a href="@Url.Action("Index", "Users")" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save"></i> Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-7">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-user"></i> User Information</h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">User ID:</dt>
                    <dd class="col-sm-8">@user.UserID</dd>

                    <dt class="col-sm-4">Username:</dt>
                    <dd class="col-sm-8"><strong>@user.Username</strong></dd>

                    <dt class="col-sm-4">Full Name:</dt>
                    <dd class="col-sm-8">@user.FullName</dd>

                    <dt class="col-sm-4">Email:</dt>
                    <dd class="col-sm-8">@user.Email</dd>

                    <dt class="col-sm-4">Role:</dt>
                    <dd class="col-sm-8">
                        <span class="badge @(user.Role == "Admin" ? "bg-danger" : user.Role == "Staff" ? "bg-primary" : user.Role == "Accountant" ? "bg-success" : "bg-info")">
                            @user.Role
                        </span>
                    </dd>

                    <dt class="col-sm-4">Status:</dt>
                    <dd class="col-sm-8">
                        <span class="badge @(user.Status == "Active" ? "bg-success" : user.Status == "Inactive" ? "bg-warning" : "bg-danger")">
                            @user.Status
                        </span>
                    </dd>
                </dl>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Password confirmation validation
        document.getElementById('confirmPassword').addEventListener('input', function () {
            var newPassword = document.getElementById('newPassword').value;
            var confirmPassword = this.value;

            if (newPassword !== confirmPassword) {
                this.setCustomValidity('Passwords do not match');
            } else {
                this.setCustomValidity('');
            }
        });

        // Also validate when new password changes
        document.getElementById('newPassword').addEventListener('input', function () {
            var confirmPassword = document.getElementById('confirmPassword');
            if (confirmPassword.value !== '') {
                confirmPassword.dispatchEvent(new Event('input'));
            }
        });
    </script>
}
